const CONFIG={STORAGE_KEY:"tornApiKey",LEVEL_RANGE_KEY:"tornLevelRange",MAX_CHECK:20,DEFAULT_LEVEL_RANGE:10,ENABLE_DELAY:3e3,API_BASE:"https://api.torn.com"},DOM={input:null,saveBtn:null,searchBtn:null,status:null,results:null,levelRange:null,decreaseBtn:null,increaseBtn:null};let currentAbortController=null,enableTimeout=null;function initDOM(){DOM.input=document.getElementById("api-key"),DOM.saveBtn=document.getElementById("save-btn"),DOM.searchBtn=document.getElementById("search-btn"),DOM.status=document.getElementById("status"),DOM.results=document.getElementById("results"),DOM.levelRange=document.getElementById("level-range"),DOM.decreaseBtn=document.getElementById("decrease-level"),DOM.increaseBtn=document.getElementById("increase-level")}function setStatus(t,e="info"){DOM.status.textContent=t,DOM.status.className=`status ${e}`}function toggleUI(t){DOM.searchBtn.disabled=t,DOM.saveBtn.disabled=t,DOM.input.disabled=t,DOM.levelRange.disabled=t,DOM.decreaseBtn.disabled=t,DOM.increaseBtn.disabled=t,t?DOM.searchBtn.classList.add("loading"):DOM.searchBtn.classList.remove("loading")}function toNumber(t){const e=Number(String(t??"").replace(/,/g,"").trim());return Number.isFinite(e)?e:Number.NaN}function loadAPIKey(){DOM.input.value=localStorage.getItem(CONFIG.STORAGE_KEY)||""}function saveAPIKey(){const t=DOM.input.value.trim();return t?(localStorage.setItem(CONFIG.STORAGE_KEY,t),setStatus("Đã lưu API key thành công!","success"),!0):(setStatus("API key không được để trống","error"),!1)}function getStoredAPIKey(){return localStorage.getItem(CONFIG.STORAGE_KEY)?.trim()||""}function loadLevelRange(){const t=localStorage.getItem(CONFIG.LEVEL_RANGE_KEY),e=t?Number.parseInt(t,10):CONFIG.DEFAULT_LEVEL_RANGE;DOM.levelRange.value=e}function saveLevelRange(t){localStorage.setItem(CONFIG.LEVEL_RANGE_KEY,t.toString())}function getLevelRange(){const t=Number.parseInt(DOM.levelRange.value,10);return Number.isFinite(t)&&t>0?t:CONFIG.DEFAULT_LEVEL_RANGE}async function fetchAPI(t,e){const n=await fetch(t,{signal:e});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const a=await n.json();if(a?.error)throw new Error(a.error.error||"API Error");return a}async function getUserBasicInfo(t,e){const n=await fetchAPI(`${CONFIG.API_BASE}/user/?selections=basic&key=${t}`,e);return{id:n.player_id||n.playerId||n.userID||n.userid,level:toNumber(n.level)}}async function getUserBattleStats(t,e,n){return toNumber((await fetchAPI(`${CONFIG.API_BASE}/user/${t}?selections=battlestats&key=${e}`,n)).total)}async function getUserProfile(t,e,n){const a=await fetchAPI(`${CONFIG.API_BASE}/user/${t}?selections=profile&key=${e}`,n),s=(()=>{const t=toNumber(a?.life?.current),e=toNumber(a?.life?.maximum);return Number.isFinite(t)&&Number.isFinite(e)?`${t.toLocaleString()}/${e.toLocaleString()}`:"N/A"})(),l=(()=>{const t=a.states||{};return toNumber(t.hospital_timestamp)>0?"Hospital":toNumber(t.jail_timestamp)>0?"Jail":t.travel_destination||t.destination?"Traveling":"Okay"})();return{name:a.name||"",level:toNumber(a.level),life:s,status:a.status?.description||a.status?.state||"Unknown",state:l}}async function loadBattleData(t){const e=await fetch("./data.json",{signal:t});if(!e.ok)throw new Error("Không thể tải data.json");return await e.json()}function normalizeDataList(t){return Array.isArray(t)?t:t?.list&&Array.isArray(t.list)?t.list:t&&"object"==typeof t?[t]:[]}function getItemLevel(t){return toNumber(t.level??t.lvl??t.Level??t.Lvl)}function getItemTotalStat(t){return toNumber(t.total_stat??t.totalStat??t.total??t.TotalStat??t["total stat"])}function filterTargets(t,e,n,a){const s=e-a,l=e+a;return t.map((t=>({...t,_level:getItemLevel(t),_total:getItemTotalStat(t)}))).filter((t=>Number.isFinite(t._level)&&Number.isFinite(t._total)&&t._level>=s&&t._level<=l&&t._total<n)).sort(((t,e)=>t._total-e._total))}function renderPlayerCard(t){const e="Hospital"===t.state?"disabled":"";return`\n    <article class="player-card">\n      <div class="card-header">\n        <h3 class="player-name">${t.name} [${t.id}]</h3>\n      </div>\n      \n      <div class="card-stats">\n        <div class="stat-item">\n          <span class="stat-label">Level</span>\n          <span class="stat-value">${t.level}</span>\n        </div>\n        <div class="stat-item">\n          <span class="stat-label">Life</span>\n          <span class="stat-value">${t.life}</span>\n        </div>\n        <div class="stat-item">\n          <span class="stat-label">Total Stat</span>\n          <span class="stat-value">${t.totalStat.toLocaleString()}</span>\n        </div>\n      </div>\n      \n      <div class="card-actions">\n        <button \n          class="btn-attack" \n          ${e}\n          data-id="${t.id}"\n        >\n          Attack\n        </button>\n      </div>\n    </article>\n  `}function renderResults(t){if(!t.length)return void(DOM.results.innerHTML='\n      <div class="empty-state">\n        <p>Không tìm thấy đối thủ phù hợp</p>\n      </div>\n    ');const e=t.map(renderPlayerCard).join("");DOM.results.innerHTML=`<div class="results-grid">${e}</div>`,DOM.results.querySelectorAll(".btn-attack").forEach((t=>{t.addEventListener("click",(()=>{if(t.disabled)return;const e=t.getAttribute("data-id");window.open(`https://www.torn.com/loader.php?sid=attack&user2ID=${e}`,"_blank","noopener,noreferrer")}))}))}async function performSearch(){const t=getStoredAPIKey();if(!t)return void setStatus("Vui lòng nhập và lưu API key trước!","error");const e=getLevelRange();saveLevelRange(e),currentAbortController&&currentAbortController.abort(),currentAbortController=new AbortController;const{signal:n}=currentAbortController;clearTimeout(enableTimeout),toggleUI(!0),renderResults([]),setStatus("Đang lấy thông tin người chơi...","info");try{const a=await getUserBasicInfo(t,n);if(!Number.isFinite(a.level))throw new Error("Không thể đọc level của bạn");const s=await getUserBattleStats(a.id,t,n);if(!Number.isFinite(s))throw new Error("Không thể đọc total stat của bạn");setStatus("Đang tải danh sách đối thủ...","info");const l=await loadBattleData(n),r=filterTargets(normalizeDataList(l),a.level,s,e),i=r.slice(0,CONFIG.MAX_CHECK),o=r.length-i.length;setStatus(`Đang kiểm tra trạng thái ${i.length} đối thủ...`,"info");const c=i.map((async e=>{const a=e.id||e.ID||e.Id;if(!a)return null;try{const s=await getUserProfile(a,t,n);return"Okay"!==s.state?null:{id:a,name:e.name||s.name||"Unknown",level:e._level??s.level,life:s.life,totalStat:e._total,status:s.status,state:s.state}}catch{return null}})),u=(await Promise.all(c)).filter(Boolean);renderResults(u);setStatus(`Hoàn tất! Tìm thấy ${u.length} đối thủ${o>0?` (đã bỏ qua ${o})`:""}`,"success"),enableTimeout=setTimeout((()=>toggleUI(!1)),CONFIG.ENABLE_DELAY)}catch(t){renderResults([]),"AbortError"===t.name?setStatus("Đã hủy tìm kiếm","info"):setStatus(t.message||"Đã xảy ra lỗi","error"),toggleUI(!1)}finally{currentAbortController=null}}function attachEventListeners(){DOM.saveBtn.addEventListener("click",saveAPIKey),DOM.searchBtn.addEventListener("click",performSearch),DOM.input.addEventListener("keydown",(t=>{"Enter"===t.key&&performSearch()})),DOM.decreaseBtn.addEventListener("click",(()=>{const t=Number.parseInt(DOM.levelRange.value,10)||CONFIG.DEFAULT_LEVEL_RANGE,e=Math.max(1,t-1);DOM.levelRange.value=e,saveLevelRange(e)})),DOM.increaseBtn.addEventListener("click",(()=>{const t=Number.parseInt(DOM.levelRange.value,10)||CONFIG.DEFAULT_LEVEL_RANGE,e=Math.min(50,t+1);DOM.levelRange.value=e,saveLevelRange(e)})),DOM.levelRange.addEventListener("change",(()=>{const t=getLevelRange();DOM.levelRange.value=t,saveLevelRange(t)}))}function init(){initDOM(),loadAPIKey(),loadLevelRange(),attachEventListeners()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init();